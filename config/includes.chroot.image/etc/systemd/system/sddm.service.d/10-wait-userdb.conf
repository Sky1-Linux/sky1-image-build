[Unit]
# Ensure systemd-userdbd is fully active before SDDM starts.
# On first boot (fresh machine-id), pam_systemd's userdb_by_name() can
# fail with ESRCH if userdbd hasn't finished initializing, which prevents
# logind session creation and breaks the Wayland compositor.
After=systemd-userdbd.service
Wants=systemd-userdbd.service

[Service]
# Gate on userdb actually resolving users before starting SDDM.
# Retries up to 10 times with 0.5s delay.
ExecStartPre=/bin/sh -c 'for i in $(seq 1 10); do userdbctl user root >/dev/null 2>&1 && exit 0; sleep 0.5; done; echo "userdb not ready, starting SDDM anyway"'
