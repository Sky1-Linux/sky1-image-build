#!/bin/bash
# /usr/local/bin/detect-display.sh
# Detect connected display and configure X for Sky1 linlondp
#
# Finds the DRM card with a connected DP/eDP output and generates
# the appropriate X.org configuration before lightdm starts.

set -euo pipefail

CONFIG_FILE="/etc/X11/xorg.conf.d/10-linlondp.conf"

log() {
    logger -t "detect-display" "$1"
}

find_connected_card() {
    local connector status card
    for connector in /sys/class/drm/card*-DP-* /sys/class/drm/card*-eDP-*; do
        [[ -f "${connector}/status" ]] || continue
        [[ "${connector}" == *Writeback* ]] && continue

        status=$(<"${connector}/status")
        if [[ "${status}" == "connected" ]]; then
            card=$(basename "${connector}")
            echo "${card%%-*}"  # Extract card0, card1, etc.
            return 0
        fi
    done
    return 1
}

generate_config() {
    local card="$1"
    cat > "${CONFIG_FILE}" << EOF
# Auto-generated by detect-display.sh - $(date)
# Display connected on: ${card}

Section "ServerFlags"
    Option "AutoAddGPU" "false"
EndSection

Section "OutputClass"
    Identifier "linlondp"
    MatchDriver "linlondp"
    Driver "modesetting"
EndSection

Section "Device"
    Identifier "DisplayCard"
    Driver "modesetting"
    Option "kmsdev" "/dev/dri/${card}"
    Option "AccelMethod" "none"
EndSection

Section "Screen"
    Identifier "Screen0"
    Device "DisplayCard"
EndSection

Section "ServerLayout"
    Identifier "Layout0"
    Screen 0 "Screen0"
EndSection
EOF
}

main() {
    log "Detecting connected display..."

    if card=$(find_connected_card); then
        log "Found display on ${card}"
        generate_config "${card}"
    else
        log "No display found, defaulting to card0"
        generate_config "card0"
    fi
}

main "$@"
