# Server Provisioning Guide

This guide covers provisioning Sky1 Linux headless server images — from flashing
to first boot.

## Overview

1. Build or download a headless server image
2. Flash the image to storage (USB, NVMe, SD card)
3. Run `sky1-provision` to write configuration to the EFI partition
4. Boot the device — configuration is applied automatically on first boot

## Prerequisites

The `sky1-provision` tool requires [uv](https://docs.astral.sh/uv/) (a Python package
manager) to run. Install it if you don't have it:

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

That's it — `uv` automatically manages the Python version the script needs. No venv
or pip install required.

> **Already have uv?** Check with `uv --version`. Any recent version works.

## Building the Server Image

```bash
cd sky1-image-build

# Build headless server image (latest kernel)
sudo ./scripts/build.sh none server image latest

# Skip compression for faster testing
sudo SKIP_COMPRESS=1 ./scripts/build.sh none server image latest
```

Output: `sky1-linux-none-server-latest-YYYYMMDD.img.xz` (or `.img` with SKIP_COMPRESS)

## Flashing

```bash
# Compressed image
xzcat sky1-linux-none-server-latest-*.img.xz | sudo dd of=/dev/sdX bs=4M status=progress
sync

# Uncompressed image (faster)
sudo dd if=sky1-linux-none-server-latest-*.img of=/dev/sdX bs=4M status=progress
sync
```

Replace `/dev/sdX` with your target device. Use `lsblk` to identify it.

## Provisioning

The `sky1-provision` tool writes a `sky1-config.txt` file to the EFI partition.
On first boot, `sky1-firstboot.service` reads this file, applies the configuration,
then securely deletes it (shred).

### Interactive Mode

```bash
sudo PATH="$PATH" ./scripts/sky1-provision /dev/sdX
```

Walks through hostname, user account, SSH keys, WiFi, timezone, etc.

> **Note**: `sudo` strips the user's PATH. The `PATH="$PATH"` prefix ensures
> `uv` (the script runner) and other tools are found.

### Non-Interactive (CLI Options)

```bash
sudo PATH="$PATH" ./scripts/sky1-provision /dev/sdX \
    --hostname myserver \
    --user admin \
    --ssh-key "ssh-ed25519 AAAA... user@host" \
    --timezone Australia/Sydney \
    --locale en_AU.UTF-8
```

### All Options

| Option | Description | Config Key |
|--------|-------------|------------|
| `--hostname NAME` | System hostname | `HOSTNAME` |
| `--user NAME` | Create user with sudo access | `USERNAME` |
| `--password PASS` | User password (hashed with SHA-512 crypt before writing) | `PASSWORD_HASH` |
| `--password-hash HASH` | Pre-hashed password (`$6$...` format) | `PASSWORD_HASH` |
| `--ssh-key FILE_OR_KEY` | SSH public key file (.pub) or raw key string | `SSH_AUTHORIZED_KEYS` |
| `--ssh-enabled yes\|no` | Enable/disable SSH server (auto-enabled when key is set) | `SSH_ENABLED` |
| `--ssh-password-auth yes\|no` | Allow SSH password login (default: yes) | `SSH_PASSWORD_AUTH` |
| `--wifi-ssid SSID` | WiFi network name | `WIFI_SSID` |
| `--wifi-password PASS` | WiFi password (converted to PSK before writing) | `WIFI_PSK` |
| `--wifi-country CC` | WiFi regulatory domain (e.g. `US`, `AU`) | `WIFI_COUNTRY` |
| `--timezone TZ` | Timezone (e.g. `America/New_York`) | `TIMEZONE` |
| `--locale LOCALE` | System locale (e.g. `en_US.UTF-8`) | `LOCALE` |
| `--keymap MAP` | Console keymap (e.g. `us`, `de`) | `KEYMAP` |

### Target Types

```bash
# Block device (auto-detects EFI partition)
sudo PATH="$PATH" ./scripts/sky1-provision /dev/sda

# Image file (loop-mounts, finds EFI partition)
sudo PATH="$PATH" ./scripts/sky1-provision sky1-linux-none-server-latest-20260215.img

# Already-mounted EFI partition
sudo PATH="$PATH" ./scripts/sky1-provision --efi /mnt/efi
```

## Configuration File Format

The provisioning tool writes `/boot/efi/sky1-config.txt`:

```ini
# Sky1 Linux pre-boot configuration
# Generated by sky1-provision
HOSTNAME=myserver
USERNAME=admin
PASSWORD_HASH=$6$rounds=5000$randomsalt$hashedpassword...
SSH_AUTHORIZED_KEYS=ssh-ed25519 AAAA... user@host
SSH_ENABLED=yes
SSH_PASSWORD_AUTH=no
TIMEZONE=Australia/Sydney
LOCALE=en_AU.UTF-8
```

You can also write this file manually — just mount the EFI partition and create
`sky1-config.txt` with any of the keys above.

### Security Notes

- **Password**: Always stored as a SHA-512 crypt hash (`$6$...`), never plaintext.
  The `--password` flag prompts and hashes locally before writing.
- **WiFi**: `--wifi-password` converts the password to a 256-bit WPA-PSK before
  writing — the plaintext password is never stored on disk.
- **Config file**: Shredded (overwritten with random data) on first boot after
  configuration is applied. Falls back to `rm -f` if `shred` is not available.
- The EFI partition is FAT32 and readable by anyone with physical access to the
  storage device. Plan accordingly.

## What Happens on First Boot

The `sky1-firstboot.service` runs once (gated by `ConditionFirstBoot=yes`) and:

1. Generates `/etc/machine-id`
2. Regenerates SSH host keys
3. Detects board type, configures GRUB
4. Reads `sky1-config.txt` from EFI partition (if present):
   - Sets hostname and `/etc/hosts`
   - Sets timezone, locale, keymap
   - Creates user with sudo, installs SSH keys
   - Configures WiFi via NetworkManager
   - Enables/configures SSH server
5. Securely deletes `sky1-config.txt`

## Default Server Configuration

Without provisioning, the headless server boots with:

| Setting | Default |
|---------|---------|
| Hostname | `sky1-default` |
| User | None (root login via console) |
| SSH | Enabled (password auth allowed) |
| Firewall | ufw enabled: allow 22 (SSH), 9090 (Cockpit) |
| Network | NetworkManager (WiFi + Ethernet) |
| Web admin | Cockpit on port 9090 |
| Web server | Caddy (Caddyfile mode, not auto-started) |
| Containers | Podman (rootless) |
| Target | `multi-user.target` (console) |

## Connecting After Boot

```bash
# If hostname was set and mDNS is available
ssh admin@myserver.local

# By IP address
ssh admin@192.168.1.x

# Cockpit web admin
https://myserver.local:9090
```

## Troubleshooting

### Can't find the device after boot

The server image uses NetworkManager. If no WiFi was provisioned and no Ethernet
cable is connected, the device won't be on the network. Connect via:
- Serial console (auto-detected from kernel `console=` parameter)
- Direct HDMI + keyboard (even on headless images)

### Provisioning didn't apply

Check if `sky1-config.txt` still exists on the EFI partition — if it does,
firstboot may not have run. Verify with:

```bash
journalctl -u sky1-firstboot.service
systemctl status sky1-firstboot.service
```

### WiFi not connecting

Verify the `.nmconnection` file was created:

```bash
ls -la /etc/NetworkManager/system-connections/
nmcli connection show
nmcli device wifi list
```
